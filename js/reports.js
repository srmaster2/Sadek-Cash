async function calculateStats(){let e=await loadAccounts(),t=await loadTransactions(1e3),n={totalBalance:0,totalTransactions:t.length,totalProfit:0};return e.forEach(e=>{n.totalBalance+=Number(e.balance)||0}),t.forEach(e=>{n.totalProfit+=Number(e.commission)||0}),n}async function getDailyReport(e){let{data:t,error:n}=await supabase.from(TABLES.transactions).select("*").gte("date",e).lt("date",new Date(new Date(e).getTime()+864e5).toISOString().split("T")[0]);return n?[]:t}async function getMonthlyReport(e,t){let n=`${t}-${e.toString().padStart(2,"0")}-01`,a=new Date(t,e,0).toISOString().split("T")[0],{data:l,error:o}=await supabase.from(TABLES.transactions).select("*").gte("date",n).lte("date",a);return o?[]:l}async function getDashboardStats(){try{let e=new Date,t=String(e.getMonth()+1).padStart(2,"0"),n=e.getFullYear(),a=String(e.getDate()).padStart(2,"0"),l=`/${t}/${n}`,o=`${a}/${t}/${n}`,s=window.currentUserData,i=e=>"function"==typeof applyBranchFilter?applyBranchFilter(e,s):e,[{data:r,error:d},{data:c},{data:u},{data:m}]=await Promise.all([i(window.supa.from("accounts").select("*")),i(window.supa.from("clients").select("name, balance")),i(window.supa.from("transactions").select("commission, amount, type, date").ilike("date",`%${l}`).limit(1e3)),i(window.supa.from("transactions").select("type, amount, date, time, added_by, notes").order("id",{ascending:!1}).limit(5))]);if(d)throw d;let b=0,y=0,g=0,p={};(r||[]).forEach(e=>{let t=(e.name||"").trim(),n=Number(e.balance)||0,a=Number(e.daily_out_limit)||0;t.includes("الخزنة")||t.includes("كاش")?b+=n:a>=9e6?(g+=n,p[t]={balance:n,color:e.color||"#4f46e5"}):y+=n});let f=0,$=0,h=[];(c||[]).forEach(e=>{let t=Number(e.balance)||0;t>0?f+=t:t<0&&($+=Math.abs(t)),0!==t&&h.push({name:e.name,balance:t})});let x=0,v=0,w=0,T=0,I=0,L=0;return(u||[]).forEach(e=>{let t=(e.date||"").trim(),n=(e.type||"").toLowerCase().trim(),a=parseFloat(e.commission)||0,l=parseFloat(e.amount)||0;if(0!==a&&(t===o&&(x+=a),v+=a),(n.includes("مصروف")||n.includes("مصاريف")||n.includes("خارج")||n.includes("عجز"))&&(w+=l),t===o){T++;let s=n.includes("سحب")||n.includes("صادر")||n.includes("مصروف");s?L+=l:I+=l}}),{success:!0,cash:b,walletsTotal:y,compTotal:g,totalAvailable:b+y+g,grandTotal:b+y+g+f-$,oweMe:f,have:$,dP:x,mP:v,ex:w,breakdown:p,clientsCards:h,todayCount:T,todayIn:I,todayOut:L,lastFive:m||[]}}catch(E){return console.error("Dashboard Error:",E),{success:!1}}}const STORAGE_KEY="sadek_cash_temp_data";async function fetchVaultBalance(){let e=document.getElementById("system-vault-val"),t=document.querySelector(".fa-sync-alt");t&&t.classList.add("fa-spin");try{let n=window.currentUserData,a=window.supa.from("accounts").select("balance, branch_id").ilike("name","%الخزنة%");!n?.isMaster&&n?.branch_id&&(a=a.eq("branch_id",n.branch_id));let{data:l,error:o}=await a;if(o)throw o;vaultBalanceFromSystem=(l||[]).reduce((e,t)=>e+(parseFloat(t.balance)||0),0),e&&(e.innerText=vaultBalanceFromSystem.toLocaleString("en-US")+" ج.م"),calculateTotalCash()}catch(s){e&&(e.innerText="خطأ في الجلب"),showToast("خطأ في جلب رصيد الخزنة",!1)}finally{t&&t.classList.remove("fa-spin")}}function renderCounter(){let e=document.getElementById("denominations-container");e&&(e.innerHTML=window.denominations.map(e=>`
        <div class="col-6 col-md-4">
            <div class="p-2 border rounded-4 bg-white shadow-sm mb-2">
                <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                    <span class="fw-bold text-dark small" style="white-space: nowrap;">فئة ${e}</span>
                    <span class="badge rounded-pill bg-primary-subtle text-primary border-primary-subtle english-num" 
                          id="subtotal-${e}" style="font-size: 10px;">0</span>
                </div>
                <input type="number" 
                       inputmode="numeric"
                       class="form-control form-control-sm text-center fw-bold english-num denom-input" 
                       placeholder="عدد الورق" 
                       data-unit="${e}" 
                       oninput="updateSubtotal(this)"
                       style="border-radius: 10px; background: #f8fafc;">
            </div>
        </div>
    `).join(""))}function updateSubtotal(e){let t=parseFloat(e.dataset.unit),n=parseFloat(e.value)||0,a=document.getElementById(`subtotal-${t}`),l=t*n;a&&(a.innerText=l.toLocaleString(),l>0?(a.classList.replace("bg-primary-subtle","bg-primary"),a.classList.replace("text-primary","text-white")):(a.classList.replace("bg-primary","bg-primary-subtle"),a.classList.replace("text-white","text-primary"))),calculateTotalCash()}async function calculateTotalCash(){let e=0,t=document.querySelectorAll(".denom-input"),n=[];t.forEach(t=>{let a=parseFloat(t.dataset.unit),l=parseFloat(t.value)||0,o=a*l;e+=o,l>0&&n.push(`${a}x${l}=${o}`)}),document.getElementById("total-cash").innerText=e.toLocaleString();let a=document.getElementById("system-vault-val").innerText,l=parseFloat(a.replace(/,/g,"").replace(" ج.م",""))||0,o=e-l,s=document.getElementById("reconciliation-badge");if(e>0){s.style.display="block";let i=document.getElementById("diff-value"),r=document.getElementById("diff-label");1>Math.abs(o)?(s.style.background="#10b981",r.innerText="الحالة: مطابق ✨",i.innerText="0"):o<0?(s.style.background="#ef4444",r.innerText="عجز بقيمة:",i.innerText=Math.abs(o).toLocaleString()+" -"):(s.style.background="#3b82f6",r.innerText="زيادة بقيمة:",i.innerText=o.toLocaleString()+" +")}else s.style.display="none";window.lastInventoryData={grandTotal:e,systemBalance:l,diff:o,details:n.join(" - ")}}function switchInventoryTab(e){let t=document.getElementById("inventory-tab-counter"),n=document.getElementById("inventory-tab-logs"),a=document.getElementById("tab-btn-counter"),l=document.getElementById("tab-btn-logs");"counter"===e?(t.style.display="block",n.style.display="none",a.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-white text-primary border",l.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-light text-muted border-0"):(t.style.display="none",n.style.display="block",l.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-white text-primary border",a.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-light text-muted border-0",loadInventoryLogs())}function showSystemToast(e,t="success"){let n=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen(e){e.addEventListener("mouseenter",Swal.stopTimer),e.addEventListener("mouseleave",Swal.resumeTimer)}});n.fire({icon:t,title:e})}async function submitInventory(){if(!window.lastInventoryData||window.lastInventoryData.grandTotal<=0){Swal.fire({title:"تنبيه",text:"لا يمكن تسجيل جرد فارغ، يرجى إدخال الفئات أولاً",icon:"warning",confirmButtonText:"موافق",customClass:{confirmButton:"btn btn-warning rounded-pill px-4"}});return}let{grandTotal:e,systemBalance:t,diff:n,details:a}=window.lastInventoryData;Swal.fire({title:"تأكيد عملية الحفظ",html:`
            <div style="text-align: right; direction: rtl;">
                <p><b>إجمالي الجرد:</b> ${e.toLocaleString()} ج.م</p>
                <p><b>رصيد السيستم:</b> ${t.toLocaleString()} ج.م</p>
                <p><b>الفارق:</b> <span style="color: ${n<0?"red":"green"}">${n.toLocaleString()} ج.م</span></p>
            </div>
        `,icon:"question",showCancelButton:!0,confirmButtonText:"تأكيد الحفظ",cancelButtonText:"إلغاء",customClass:{confirmButton:"btn btn-primary rounded-pill px-4 me-2",cancelButton:"btn btn-light rounded-pill px-4"},buttonsStyling:!1}).then(async l=>{if(l.isConfirmed)try{Swal.showLoading();let{data:{user:o}}=await window.supa.auth.getUser(),s=o?.user_metadata?.full_name||o?.user_metadata?.name||o?.email||"موظف غير معروف",{error:i}=await window.supa.from("inventory_logs").insert([{system_balance:t,actual_balance:e,diff:n,details:a,user_name:s}]);if(i)throw i;showSystemToast("تم تسجيل الجرد بنجاح"),resetCounter(),loadInventoryLogs(),switchInventoryTab("logs")}catch(r){Swal.fire("خطأ!",r.message,"error")}})}async function calculateTotalCash(){let e=0,t=document.querySelectorAll(".denom-input"),n=[];t.forEach(t=>{let a=parseFloat(t.dataset.unit),l=parseFloat(t.value)||0,o=a*l;e+=o,l>0&&n.push(`${a}x${l}=${o}`)}),document.getElementById("total-cash").innerText=e.toLocaleString();let a=document.getElementById("system-vault-val"),l=parseArabicNumber(a.innerText),o=e-l,s=document.getElementById("reconciliation-badge"),i=document.getElementById("diff-value"),r=document.getElementById("diff-label");e>0||t.length>0?(s.style.display="block",.1>Math.abs(o)?(s.style.background="#10b981",r.innerText="الحالة: مطابق للسيستم ✨",i.innerText="0"):o<0?(s.style.background="#ef4444",r.innerText="النتيجة: عجز بقيمة",i.innerText=Math.abs(o).toLocaleString()+" -"):(s.style.background="#3b82f6",r.innerText="النتيجة: زيادة بقيمة",i.innerText=o.toLocaleString()+" +")):s.style.display="none",window.lastInventoryData={grandTotal:e,systemBalance:l,diff:o,details:n.join(" - ")}}function updateReconciliationUI(e,t){let n=document.getElementById("reconciliation-badge"),a=document.getElementById("diff-label"),l=document.getElementById("diff-value");if(!n)return;if(0===e&&0===vaultBalanceFromSystem){n.style.display="none";return}n.style.display="block";let o=e-vaultBalanceFromSystem,s=t.join(" - "),i=`
        <div class="mt-3 pt-3" style="border-top: 1px dashed rgba(255,255,255,0.4)">
            <button id="btnSaveInventory" class="btn w-100 fw-bold shadow-sm" 
                    style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 12px; padding: 10px; font-size: 13px;"
                    onclick="saveInventoryToSupabase(${vaultBalanceFromSystem}, ${e}, ${o}, '${s}')">
                <i class="fas fa-check-circle me-1"></i> اعتماد وتسجيل الجرد في السجل
            </button>
        </div>`;1>Math.abs(o)?(n.style.background="linear-gradient(135deg, #059669, #10b981)",a.innerHTML="✨ جرد مطابق",l.innerHTML="0"+i):o<0?(n.style.background="linear-gradient(135deg, #dc2626, #ef4444)",a.innerHTML="⚠️ عجز:",l.innerHTML=Math.abs(o).toLocaleString()+" ج.م"+i):(n.style.background="linear-gradient(135deg, #2563eb, #3b82f6)",a.innerHTML="\uD83D\uDCB0 زيادة:",l.innerHTML=o.toLocaleString()+" ج.م"+i)}function restoreInventoryData(){let e=sessionStorage.getItem(STORAGE_KEY);if(!e)return;let t=JSON.parse(e);document.querySelectorAll(".denom-input").forEach(e=>{let n=e.getAttribute("data-unit");t[n]&&(e.value=t[n])}),calculateTotalCash()}function resetCounter(){Swal.fire({title:"تصفير الحاسبة؟",text:"سيتم مسح جميع الأرقام المدخلة في الفئات حالاً",icon:"warning",showCancelButton:!0,confirmButtonText:"نعم، تصفير",cancelButtonText:"إلغاء",customClass:{confirmButton:"btn btn-danger rounded-pill px-4 me-2",cancelButton:"btn btn-light rounded-pill px-4"},buttonsStyling:!1}).then(e=>{if(e.isConfirmed){let t=document.querySelectorAll(".denom-input");t.forEach(e=>e.value="");let n=document.querySelectorAll(".sub-total");n.forEach(e=>{e.innerText="0",e.classList.replace("bg-primary","bg-primary-subtle"),e.classList.replace("text-white","text-primary")}),calculateTotalCash();let a=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3,timerProgressBar:!0});a.fire({icon:"success",title:"تم تصفير الحاسبة بنجاح"})}})}async function saveInventoryToSupabase(e,t,n,a){if(confirm("تأكيد حفظ الجرد في السجل؟")){setLoading("btnSaveInventory",!0);try{let{data:{user:l}}=await window.supa.auth.getUser(),{error:o}=await window.supa.from("inventory_logs").insert([{system_balance:e,actual_balance:t,diff:n,details:a,user_name:l?.user_metadata?.name||l?.email}]);if(o)throw o;showToast("تم تسجيل الجرد بنجاح"),sessionStorage.removeItem(STORAGE_KEY),resetCounter()}catch(s){showToast("خطأ: "+s.message,!1)}finally{setLoading("btnSaveInventory",!1)}}}void 0===window.denominations&&(window.denominations=[200,100,50,20,10,5,1]);const oldShowView=window.showView;async function loadDenominations(){renderCounter()}function switchInventoryTab(e){let t=document.getElementById("inventory-tab-counter"),n=document.getElementById("inventory-tab-logs"),a=document.getElementById("tab-btn-counter"),l=document.getElementById("tab-btn-logs");"counter"===e?(t.style.display="block",n.style.display="none",a.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-white text-primary border",l.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-light text-muted border-0"):(t.style.display="none",n.style.display="block",l.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-white text-primary border",a.className="btn btn-sm flex-fill rounded-pill fw-bold shadow-sm py-2 bg-light text-muted border-0",loadInventoryLogs())}async function loadInventoryLogs(){let e=document.getElementById("inventory-logs-list"),t=document.getElementById("log-refresh-icon");window._logsData=[],t&&t.classList.add("fa-spin"),e.innerHTML||(e.innerHTML='<div class="text-center py-4 text-muted small">جاري جلب البيانات...</div>');try{let{data:n,error:a}=await window.supa.from("inventory_logs").select("*").order("created_at",{ascending:!1}).limit(20);if(a)throw a;let l="";n&&0!==n.length?n.forEach(e=>{let t=new Date(e.created_at),n=parseFloat(e.diff)||0;window._logsData.push(e);let a=window._logsData.length-1,o="";o=1>Math.abs(n)?'<span class="badge bg-success-subtle text-success border-0 rounded-pill px-3">مطابق ✨</span>':n<0?`<span class="badge bg-danger-subtle text-danger border-0 rounded-pill px-2">عجز: ${Math.abs(n).toLocaleString()}</span>`:`<span class="badge bg-primary-subtle text-primary border-0 rounded-pill px-2">زيادة: ${n.toLocaleString()}</span>`,l+=`
                <div class="log-card shadow-sm border rounded-4 p-3 mb-2 bg-white d-flex align-items-center">
                    <div class="col-4 text-start">
                        <div class="fw-bold text-dark small">${t.toLocaleDateString("ar-EG")}</div>
                        <div class="text-muted" style="font-size: 10px;">${t.toLocaleTimeString("ar-EG",{hour:"2-digit",minute:"2-digit"})}</div>
                    </div>
                    <div class="col-5 text-center">${o}</div>
                    <div class="col-3 text-end d-flex justify-content-end gap-1">
                        <button class="btn btn-action view" onclick="openLogModal(window._logsData[${a}])" title="التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-action delete" onclick="deleteInventoryLog('${e.id}')" title="حذف">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>`}):l='<div class="text-center py-5 text-muted">لا يوجد سجلات حالياً</div>',e.innerHTML=l}catch(o){console.error("Error loading logs:",o),e.innerHTML='<div class="alert alert-danger m-2 small text-center">خطأ في الاتصال بالقاعدة</div>'}finally{t&&t.classList.remove("fa-spin")}}function openLogModal(e){let t=document.getElementById("modal-date-head"),n=document.getElementById("modal-user"),a=document.getElementById("modal-system"),l=document.getElementById("modal-actual"),o=document.getElementById("modal-details-list");if(t){let s=new Date(e.created_at);t.innerText=isNaN(s)?"تاريخ غير صحيح":s.toLocaleString("ar-EG")}if(n&&(n.innerText=e.user_name||"غير معروف"),a&&(a.innerText=Number(e.system_balance||0).toLocaleString()+" ج.م"),l&&(l.innerText=Number(e.actual_balance||0).toLocaleString()+" ج.م"),o){if(e.details){let i=e.details.split(" - ");o.innerHTML=i.map(e=>`<div class="denom-tag border p-1 rounded bg-light small px-2">${e}</div>`).join("")}else o.innerHTML='<span class="text-muted small">لا توجد تفاصيل</span>'}let r=document.getElementById("logDetailsModal");r?r.style.display="flex":console.error("عنصر logDetailsModal غير موجود في الـ HTML")}function closeLogModal(){let e=document.getElementById("logDetailsModal");e&&(e.style.display="none")}function closeLogModalOutside(e){let t=document.getElementById("logDetailsModal");e.target===t&&(t.style.display="none")}function viewLogDetails(e,t){let n=`المسؤول: ${e}

التفاصيل:
${t}`;window.Swal?Swal.fire({title:"تفاصيل عملية الجرد",html:`<div style="text-align: right; font-size: 14px;"><b>المسؤول:</b> ${e}<br><hr>${t.replace(/-/g,"<br>")}</div>`,icon:"info",confirmButtonText:"إغلاق"}):alert(n)}function renderAdminDenomsList(){let e=document.getElementById("delete-denoms-list");if(!e)return;let t="";window.denominations.forEach(e=>{t+=`
        <div class="badge bg-white text-dark border p-2 d-flex align-items-center gap-2 shadow-sm" style="border-radius: 10px;">
            <span class="fw-bold">${e} ج.م</span>
            <i class="fas fa-times-circle text-danger" style="cursor: pointer;" onclick="deleteDenomination(${e})" title="حذف الفئة"></i>
        </div>`}),e.innerHTML=t||'<span class="text-muted small">لا توجد فئات مضافة</span>'}async function deleteInventoryLog(e){let t=confirm("هل أنت متأكد من حذف هذا السجل؟ لا يمكن التراجع.");if(t)try{let{error:n}=await window.supa.from("inventory_logs").delete().eq("id",e);if(n)throw n;loadInventoryLogs(),window.showToast?showToast("تم حذف السجل بنجاح"):alert("تم حذف السجل بنجاح")}catch(a){console.error("Delete error:",a),alert("فشل الحذف: تأكد من صلاحيات قاعدة البيانات")}}async function refreshVaultWithToast(){let e=document.getElementById("refresh-vault-icon");e&&e.classList.add("fa-spin");try{await fetchVaultBalance(),setTimeout(calculateTotalCash,500),window.showToast&&showToast("تم تحديث رصيد السيستم",!0)}finally{e&&setTimeout(()=>e.classList.remove("fa-spin"),800)}}function parseArabicNumber(e){return e&&parseFloat(e.toString().replace(/[^\d.]/g,""))||0}window.showView=function(e){"function"==typeof oldShowView&&oldShowView(e),"counter"===e&&(renderCounter(),fetchVaultBalance())},setInterval(()=>{let e=document.getElementById("inventory-tab-logs");e&&"none"!==e.style.display&&loadInventoryLogs()},3e4);
