var searchTimeout,_toastTimer=null;function showToast(t,e){void 0===e&&(e=!0);let a=document.getElementById("toastMsg");a&&(a.textContent=t,a.className="custom-toast show "+(e?"toast-success":"toast-error"),clearTimeout(_toastTimer),_toastTimer=setTimeout(()=>{a.className="custom-toast"},3500))}function setLoading(t,e){let a=document.getElementById(t);a&&(a.disabled=e,e?(a._originalText=a.innerHTML,a.innerHTML='<i class="fa fa-circle-notch fa-spin me-1"></i> جاري التنفيذ...'):a.innerHTML=a._originalText||a.innerHTML)}function formatNumberInput(t){let e=t.value.replace(/[^0-9.]/g,""),a=e.split(".");a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),t.value=a.join(".")}async function loadWallets(){let t=document.getElementById("wallet");if(t){t.innerHTML="<option>جاري التحميل...</option>";try{let e=window.currentUserData,a=window.supa.from("accounts").select("id, name, balance, daily_out_limit, daily_in_limit, monthly_limit, daily_out_usage, daily_in_usage, monthly_usage_out").order("name");"function"==typeof applyBranchFilter&&(a=applyBranchFilter(a,e));let{data:n,error:l}=await a;if(l)throw l;t.innerHTML='<option value="">اختر الحساب...</option>',n?.forEach(e=>{let a=Number(e.balance||0).toLocaleString();t.innerHTML+=`<option value="${e.id}"
                data-bal="${e.balance||0}"
                data-lo="${e.daily_out_limit||0}"
                data-li="${e.daily_in_limit||0}"
                data-lm="${e.monthly_limit||0}"
                data-uo="${e.daily_out_usage||0}"
                data-ui="${e.daily_in_usage||0}"
                data-um="${e.monthly_usage_out||0}">
                ${e.name} (${a} ج.م)
            </option>`})}catch(i){t.innerHTML="<option>خطأ في التحميل</option>",console.error("loadWallets error:",i)}}}function updateLimitDisplay(){let t=document.getElementById("wallet"),e=document.getElementById("limitStatus");if(!t||!e)return;let a=t.options[t.selectedIndex],n=document.getElementById("type")?.value||"";if(!a||!a.value||n.includes("مصروف")){e.style.display="none";return}let l=Number(a.dataset.bal)||0,i=Number(a.dataset.lo)||0,s=Number(a.dataset.li)||0,o=Number(a.dataset.lm)||0,d=Number(a.dataset.uo)||0,r=Number(a.dataset.ui)||0,c=Number(a.dataset.um)||0;if(!i&&!s&&!o){e.style.display="none";return}let u=Math.max(0,Math.min(i-d,o-c)),m=Math.max(0,s-r);e.style.display="block",e.innerHTML=`
        <div class="wallet-info-card shadow-sm" style="
            background: var(--bg-card, #1e293b);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 12px 15px;
            margin-top: 8px;
            direction: rtl;
        ">
            <!-- الرصيد الحالي -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px dashed rgba(255,255,255,0.1);">
                <span style="font-size:12px; color:var(--text-muted, #94a3b8);">الرصيد الحالي</span>
                <span class="${l<300?"text-danger fw-bold":l<1e3?"text-warning fw-bold":"text-success fw-bold"}" style="font-size:15px;">${l.toLocaleString()} <small style="font-size:11px">ج.م</small></span>
            </div>
            <!-- متاح دخول / خروج -->
            <div style="display:flex; gap:8px;">
                <div style="flex:1; text-align:center; background:rgba(16,185,129,0.08); border-radius:10px; padding:8px 6px;">
                    <div style="font-size:10px; color:var(--text-muted,#94a3b8); margin-bottom:4px;">
                        <i class="fa fa-arrow-down" style="color:#10b981;"></i> متاح دخول
                    </div>
                    <div class="${m<500?"text-danger fw-bold":m<2e3?"text-warning fw-bold":"text-success fw-bold"}" style="font-size:14px;">${m.toLocaleString()}</div>
                </div>
                <div style="flex:1; text-align:center; background:rgba(239,68,68,0.08); border-radius:10px; padding:8px 6px;">
                    <div style="font-size:10px; color:var(--text-muted,#94a3b8); margin-bottom:4px;">
                        <i class="fa fa-arrow-up" style="color:#ef4444;"></i> متاح خروج
                    </div>
                    <div class="${u<500?"text-danger fw-bold":u<2e3?"text-warning fw-bold":"text-success fw-bold"}" style="font-size:14px;">${u.toLocaleString()}</div>
                </div>
            </div>
            ${o>0&&o-c<i-d?`
            <div style="margin-top:8px; font-size:10px; color:#ef4444; font-weight:bold; text-align:center;">
                ⚠️ المحفظة مقيدة بالحد الشهري
            </div>`:""}
        </div>`}function updateLimitDisplayBoth(){let t=document.getElementById("wallet-both");if(!t)return}async function fetchClientBalance(){let t=document.getElementById("client")?.value,e=document.getElementById("clientBalanceStatus");if(!e)return;if(!t){e.textContent="";return}let{data:a,error:n}=await window.supa.from("clients").select("balance, name").eq("id",t).single();if(!n&&a){let l=Number(a.balance||0);e.className=`small fw-bold mt-1 text-center ${l>0?"text-danger":"text-success"}`,e.textContent=`رصيد ${a.name}: ${Math.abs(l).toLocaleString()} ج.م ${l>0?"(عليه)":"(له)"}`}}async function loadClientsToSelect(){let t=document.getElementById("client");if(!t)return;let e=window.currentUserData,a=window.supa.from("clients").select("id, name, balance").order("name");"function"==typeof applyBranchFilter&&(a=applyBranchFilter(a,e));let{data:n}=await a;n&&(t.innerHTML='<option value="">اختر العميل...</option>',n.forEach(e=>{let a=Number(e.balance)||0,n=a<0?` | عليه: ${Math.abs(a).toLocaleString()}`:a>0?` | له: ${a.toLocaleString()}`:"";t.innerHTML+=`<option value="${e.id}">${e.name}${n}</option>`}))}async function loadClientsTable(){let t=document.getElementById("manage-clients-body");if(!t)return;t.innerHTML='<div class="text-center p-3"><i class="fa fa-spin fa-circle-notch"></i></div>';let e=window.currentUserData,a=window.supa.from("clients").select("*").order("name");"function"==typeof applyBranchFilter&&(a=applyBranchFilter(a,e));let{data:n,error:l}=await a;if(l||!n){t.innerHTML='<div class="text-center text-danger small p-3">خطأ في التحميل</div>';return}if(!n.length){t.innerHTML='<div class="text-center text-muted small p-3">لا يوجد عملاء</div>';return}t.innerHTML=n.map(t=>{let e=Number(t.balance||0);return`
        <div class="d-flex align-items-center p-2 border-bottom" style="font-size:13px;">
            <div style="width:25%;" class="fw-bold text-start text-truncate">${t.name}</div>
            <div style="width:30%;" class="text-center english-num text-muted">${t.number||"-"}</div>
            <div style="width:30%;" class="text-center english-num fw-bold ${e>0?"text-danger":"text-success"}">${Math.abs(e).toLocaleString()}</div>
            <div style="width:10%;" class="text-center">
                <button class="btn btn-sm p-1" onclick="openEditCl('${t.id}','${t.name}','${t.number||""}',${e})">
                    <i class="fa fa-edit text-primary"></i>
                </button>
                <button class="btn btn-sm btn-light border text-danger p-1" onclick="deleteClient(${t.id},'${t.name}')">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
        </div>`}).join("")}async function deleteClient(t,e){let{isConfirmed:a}=await Swal.fire({title:"حذف العميل؟",text:`هل أنت متأكد من حذف "${e}"؟`,icon:"warning",showCancelButton:!0,confirmButtonText:"حذف",cancelButtonText:"إلغاء"});if(!a)return;let n=parseInt(t);if(isNaN(n)){showToast("❌ خطأ في معرف العميل",!1);return}let{error:l}=await window.supa.from("clients").delete().eq("id",n);l?showToast("❌ فشل الحذف: "+l.message,!1):(showToast("✅ تم حذف العميل بنجاح",!0),loadClientsTable())}async function addClient(){let t=document.getElementById("newClientName")||document.getElementById("newClName"),e=document.getElementById("newClientPhone")||document.getElementById("newClPhone"),a=t?.value?.trim(),n=e?.value?.trim()||"";if(!a)return showToast("⚠️ أدخل اسم العميل",!1);setLoading("btnAddClient",!0);try{let{error:l}=await window.supa.from("clients").insert([{name:a,number:n,balance:0,branch_id:window.currentUserData?.branch_id||null}]);if(l)throw l;showToast("✅ تم إضافة العميل",!0),t&&(t.value=""),e&&(e.value=""),loadClientsTable(),loadClientsToSelect()}catch(i){showToast("❌ "+i.message,!1)}finally{setLoading("btnAddClient",!1)}}async function loadUsersList(){let t=document.getElementById("usersList");if(!t)return;t.innerHTML='<div class="text-center p-3"><i class="fa fa-spin fa-circle-notch"></i></div>';let{data:e,error:a}=await window.supa.from("users").select("*").order("name");if(a||!e){t.innerHTML='<div class="text-center text-danger p-3">خطأ في التحميل</div>';return}t.innerHTML=e.map(t=>`
        <div class="d-flex align-items-center p-2 mb-2 border rounded-3" style="direction:rtl;">
            <div style="width:50%;">
                <div class="fw-bold small">${t.name||t.email}</div>
                <div class="text-muted" style="font-size:11px;">${t.email}</div>
            </div>
            <div style="width:25%;" class="text-center">
                <span class="badge ${"ADMIN"===t.role?"bg-danger":"bg-secondary"}">${"ADMIN"===t.role?"أدمن":"موظف"}</span>
            </div>
            <div style="width:25%;" class="text-end pe-2">
                <button class="btn btn-sm btn-light border" onclick="openEditRole('${t.email}','${t.name||t.email}')">
                    <i class="fa fa-user-shield text-primary"></i>
                </button>
            </div>
        </div>`).join("")}function toggleDateFilters(){let t=document.getElementById("dateFilterSection");t&&(t.style.display="none"!==t.style.display&&t.style.display?"none":"flex")}function resetAdvancedSearch(){["advSearchText","advSearchType","advDateFrom","advDateTo"].forEach(t=>{let e=document.getElementById(t);e&&(e.value="")});let t=document.getElementById("dateFilterSection");t&&(t.style.display="none"),"function"==typeof executeAdvancedSearch&&executeAdvancedSearch()}function showManageTab(t){let e=t.dataset.tab;document.querySelectorAll(".manage-tab-content").forEach(t=>t.style.display="none"),document.querySelectorAll(".nav-pills .nav-link").forEach(t=>t.classList.remove("active"));let a=document.getElementById(e);a&&(a.style.display="block"),t.classList.add("active"),"clients-tab"===e?loadClientsTable():"accounts-tab"===e?"function"==typeof loadAccountsTable&&loadAccountsTable():"users-tab"===e?loadUsersList():"logs-tab"===e?"function"==typeof loadAdminLogs&&loadAdminLogs():"branches-tab"===e&&("function"==typeof loadBranchesTable&&loadBranchesTable(),"function"==typeof populateBranchSelect&&populateBranchSelect("assignBranchSelect"),"function"==typeof loadUsersForAssign&&loadUsersForAssign())}var _accountsLiveSub=null;function setupAccountsLive(){_accountsLiveSub||(_accountsLiveSub=window.supa.channel("live:accounts").on("postgres_changes",{event:"UPDATE",schema:"public",table:"accounts"},function(t){let e=t.new;if(!e)return;_patchWalletOption(e);let a=document.getElementById("wallet"),n=a?.options[a.selectedIndex];n&&String(n.value)===String(e.id)&&(_patchOptionDataset(n,e),updateLimitDisplay()),"function"==typeof renderPinnedWallets&&renderPinnedWallets()}).subscribe())}function _patchOptionDataset(t,e){t.dataset.bal=null!=e.balance?e.balance:t.dataset.bal,t.dataset.lo=null!=e.daily_out_limit?e.daily_out_limit:t.dataset.lo,t.dataset.li=null!=e.daily_in_limit?e.daily_in_limit:t.dataset.li,t.dataset.lm=null!=e.monthly_limit?e.monthly_limit:t.dataset.lm,t.dataset.uo=null!=e.daily_out_usage?e.daily_out_usage:t.dataset.uo,t.dataset.ui=null!=e.daily_in_usage?e.daily_in_usage:t.dataset.ui,t.dataset.um=null!=e.monthly_usage_out?e.monthly_usage_out:t.dataset.um;var a=t.text.replace(/\s*\(.*\)/,"").trim();t.text=a+" ("+Number(e.balance||0).toLocaleString()+" ج.م)"}function _patchWalletOption(t){var e=document.getElementById("wallet");if(e){for(var a=0;a<e.options.length;a++)if(String(e.options[a].value)===String(t.id)){_patchOptionDataset(e.options[a],t);break}}}function toggleTheme(){document.body.classList.toggle("light-mode");let t=document.body.classList.contains("light-mode");document.querySelectorAll(".icon-btn .fa-moon, .icon-btn .fa-sun").forEach(e=>{t?e.classList.replace("fa-moon","fa-sun"):e.classList.replace("fa-sun","fa-moon")});let e=document.getElementById("darkModeToggleIcon");e&&(e.className=t?"fa fa-toggle-on text-primary":"fa fa-toggle-off"),localStorage.setItem("theme",t?"light":"dark")}async function loadProfileSettings(){try{let{data:{user:t}}=await window.supa.auth.getUser();if(!t)return;let{data:e}=await window.supa.from("users").select("*").eq("email",t.email).maybeSingle(),a=document.getElementById("displayProfileName"),n=document.getElementById("displayProfileEmail"),l=document.getElementById("displayProfileRole");a&&(a.textContent=e?.name||t.user_metadata?.name||"غير محدد"),n&&(n.textContent=t.email),l&&(l.textContent=e?.is_master?"⭐ المدير العام":({ADMIN:"\uD83D\uDD34 أدمن",USER:"\uD83D\uDFE2 موظف"})[e?.role]||"موظف")}catch(i){console.error("loadProfileSettings error:",i)}}function switchInventoryTab(t){let e=document.getElementById("inventory-tab-counter"),a=document.getElementById("inventory-tab-logs"),n=document.getElementById("tab-btn-counter"),l=document.getElementById("tab-btn-logs");"counter"===t?(e&&(e.style.display="block"),a&&(a.style.display="none"),n&&(n.classList.add("bg-white","text-primary"),n.classList.remove("bg-light","text-muted")),l&&(l.classList.remove("bg-white","text-primary"),l.classList.add("bg-light","text-muted")),"function"==typeof renderCounter&&renderCounter()):(e&&(e.style.display="none"),a&&(a.style.display="block"),l&&(l.classList.add("bg-white","text-primary"),l.classList.remove("bg-light","text-muted")),n&&(n.classList.remove("bg-white","text-primary"),n.classList.add("bg-light","text-muted")),"function"==typeof loadInventoryLogs&&loadInventoryLogs())}async function refreshVaultWithToast(){let t=document.getElementById("refresh-vault-icon");t&&t.classList.add("fa-spin");try{let{data:e}=await window.supa.from("accounts").select("balance").eq("name","الخزنة (الكاش)").single(),a=document.getElementById("system-vault-val");a&&e&&(a.textContent=Number(e.balance).toLocaleString()),showToast("✅ تم تحديث رصيد الخزنة")}catch(n){showToast("❌ خطأ في التحديث",!1)}finally{t&&t.classList.remove("fa-spin")}}async function getTransactionLogs(t){t=t||{};try{let e=window.currentUserData,a=window.supa.from("transactions").select("id, date, time, type, amount, commission, wallet_name, provider, balance_after, notes, added_by").order("id",{ascending:!1});"function"==typeof applyBranchFilter&&(a=applyBranchFilter(a,e)),t.type&&!t.type.includes("كل العمليات")&&(a=a.ilike("type",`%${t.type}%`)),t.dateFrom&&(a=a.gte("date",t.dateFrom)),t.dateTo&&(a=a.lte("date",t.dateTo));let n=t.type||t.dateFrom||t.dateTo?1e3:50;a=a.limit(n);let{data:l,error:i}=await a;if(i)throw i;return l}catch(s){return console.error("getTransactionLogs error:",s),null}}document.addEventListener("DOMContentLoaded",function(){let t=localStorage.getItem("theme");if("light"===t){document.body.classList.add("light-mode"),document.querySelectorAll(".icon-btn .fa-moon").forEach(t=>t.classList.replace("fa-moon","fa-sun"));let e=document.getElementById("darkModeToggleIcon");e&&(e.className="fa fa-toggle-on text-primary")}var a=0,n=setInterval(function(){a++,window.supa?(clearInterval(n),setupAccountsLive()):a>20&&clearInterval(n)},500)});
